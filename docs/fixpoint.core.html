<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>fixpoint.core documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="highlight/solarized-light.css" /><script type="text/javascript" src="highlight/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a> with <a href="https://github.com/xsc/codox-theme-rdash">RDash UI</a> theme</h2><h1><a href="index.html"><span class="project-title"><span class="project-name">fixpoint</span> <span class="project-version">0.1.1</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fixpoint</span></div></div></li><li class="depth-2 branch current"><a href="fixpoint.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datasource</span></div></div></li><li class="depth-3 branch"><a href="fixpoint.datasource.elastic.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>elastic</span></div></a></li><li class="depth-3 branch"><a href="fixpoint.datasource.hikari.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>hikari</span></div></a></li><li class="depth-3 branch"><a href="fixpoint.datasource.jdbc.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jdbc</span></div></a></li><li class="depth-3 branch"><a href="fixpoint.datasource.mysql.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mysql</span></div></a></li><li class="depth-3"><a href="fixpoint.datasource.postgresql.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>postgresql</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="fixpoint.core.html#var-as"><div class="inner"><span>as</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-by-namespace"><div class="inner"><span>by-namespace</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-Datasource"><div class="inner"><span>Datasource</span></div></a></li><li class="depth-2 branch"><a href="fixpoint.core.html#var-as-raw-datasource"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>as-raw-datasource</span></div></a></li><li class="depth-2 branch"><a href="fixpoint.core.html#var-datasource-id"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datasource-id</span></div></a></li><li class="depth-2 branch"><a href="fixpoint.core.html#var-insert-document.21"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>insert-document!</span></div></a></li><li class="depth-2 branch"><a href="fixpoint.core.html#var-run-with-rollback"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>run-with-rollback</span></div></a></li><li class="depth-2 branch"><a href="fixpoint.core.html#var-start-datasource"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>start-datasource</span></div></a></li><li class="depth-2"><a href="fixpoint.core.html#var-stop-datasource"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>stop-datasource</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-datasource"><div class="inner"><span>datasource</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-Fixture"><div class="inner"><span>Fixture</span></div></a></li><li class="depth-2"><a href="fixpoint.core.html#var-fixture-documents"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>fixture-documents</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-id"><div class="inner"><span>id</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-ids"><div class="inner"><span>ids</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-match"><div class="inner"><span>match</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-maybe-datasource"><div class="inner"><span>maybe-datasource</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-on-datasource"><div class="inner"><span>on-datasource</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-properties"><div class="inner"><span>properties</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-property"><div class="inner"><span>property</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-raw-datasource"><div class="inner"><span>raw-datasource</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-use-data"><div class="inner"><span>use-data</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-use-datasources"><div class="inner"><span>use-datasources</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-with-data"><div class="inner"><span>with-data</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-with-datasource"><div class="inner"><span>with-datasource</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-with-rollback"><div class="inner"><span>with-rollback</span></div></a></li><li class="depth-1"><a href="fixpoint.core.html#var-with-rollback-datasource"><div class="inner"><span>with-rollback-datasource</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">fixpoint.core</h1><div class="doc"><div class="markdown"><p>Fixture Functions and Protocols</p></div></div><div class="public anchor" id="var-as"><h3>as</h3><div class="usage"><code>(as data document-id)</code></div><div class="doc"><div class="markdown"><p>Declare the given fixture’s reference ID, which can be used from within other fixtures.</p>
<pre><code class="clojure">(defn person
  [reference name]
  (-&gt; {:db/table :people
       :name     name}
      (as reference)
      (on-datasource :db)))

(defn post
  [reference author-reference text]
  (-&gt; {:db/table :posts
       :author-id author-reference
       :text      text}
      (as reference)
      (on-datasource :db)))
</code></pre>
<p>A simple set of fixtures could be:</p>
<pre><code class="clojure">[(person :person/me "me")
 (post   :post/happy :person/me "yay!")]
</code></pre>
<p>You can also reference specific fields of other documents using a vector notation, e.g. to declare a post with the same author as <code>:post/happy</code>:</p>
<pre><code class="clojure">(post :post/again [:post/happy :author-id] "still yay!")
</code></pre>
<p>Note that every reference ID can be used <em>exactly once</em>. </p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L451">view source</a></div></div><div class="public anchor" id="var-by-namespace"><h3>by-namespace</h3><div class="usage"><code>(by-namespace nspace &amp; path)</code></div><div class="doc"><div class="markdown"><p>Retrieve a <a href="fixpoint.core.html#var-property">property</a> for each entity whose reference (attached using <a href="fixpoint.core.html#var-as">as</a>) has the given namespace.</p>
<pre><code class="clojure">(with-datasource [ds (pg/make-datasource :db ...)]
  (with-data [(person :person/me  "me")
              (person :person/you "you")
              (post   :post/happy :person/me "yay!")]
    (by-namespace :person :id)))
;; =&gt; {:person/me 1, :person/you 2}
</code></pre>
<p>Returns a map associating the reference (see <a href="fixpoint.core.html#var-as">as</a>) with the queried property.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L378">view source</a></div></div><div class="public anchor" id="var-Datasource"><h3>Datasource</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>Protocol for fixture-capable test datasources.</p></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-as-raw-datasource"><h3>as-raw-datasource</h3><div class="usage"><code>(as-raw-datasource this)</code></div><div class="doc"><div class="markdown"><p>Retrieve the underlying raw datasource, e.g. a <code>clojure.java.jdbc</code> database spec, or some raw connection object.</p>
<p>This should fail on non-started datasources.</p></div></div></div><div class="public anchor" id="var-datasource-id"><h3>datasource-id</h3><div class="usage"><code>(datasource-id this)</code></div><div class="doc"><div class="markdown"><p>Return an ID for this datasource.</p></div></div></div><div class="public anchor" id="var-insert-document.21"><h3>insert-document!</h3><div class="usage"><code>(insert-document! this document)</code></div><div class="doc"><div class="markdown"><p>Insert the given <code>data</code> into the current datasource. Return a map of <code>:id</code> (the reference ID), <code>:data</code> (the actual data inserted) and optionally <code>:tags</code> (a seq of tags for entity filtering).</p>
<p>Reference IDs <strong>must</strong> be namespaced keywords.</p></div></div></div><div class="public anchor" id="var-run-with-rollback"><h3>run-with-rollback</h3><div class="usage"><code>(run-with-rollback this f)</code></div><div class="doc"><div class="markdown"><p>Run <code>(f datasource)</code>, where <code>datasource</code> is a transacted version of the current datasource. Ensure that changes made via <code>datasource</code> are rolled back afterwards.</p></div></div></div><div class="public anchor" id="var-start-datasource"><h3>start-datasource</h3><div class="usage"><code>(start-datasource this)</code></div><div class="doc"><div class="markdown"><p>Start the datasource.</p></div></div></div><div class="public anchor" id="var-stop-datasource"><h3>stop-datasource</h3><div class="usage"><code>(stop-datasource this)</code></div><div class="doc"><div class="markdown"><p>Stop the datasource.</p></div></div></div></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L9">view source</a></div></div><div class="public anchor" id="var-datasource"><h3>datasource</h3><div class="usage"><code>(datasource id)</code></div><div class="doc"><div class="markdown"><p>Get the <a href="fixpoint.core.html#var-Datasource">Datasource</a> registered under the given ID within the current scope. Throws an <code>AssertionError</code> if there is none.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L69">view source</a></div></div><div class="public anchor" id="var-Fixture"><h3>Fixture</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>Protocol for datasource fixtures.</p></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-fixture-documents"><h3>fixture-documents</h3><div class="usage"><code>(fixture-documents this)</code></div><div class="doc"><div class="markdown"><p>Generate a seq of fixture document maps, each one belonging to a single datasource identified by the <code>:fixpoint/datasource</code> key.</p></div></div></div></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L33">view source</a></div></div><div class="public anchor" id="var-id"><h3>id</h3><div class="usage"><code>(id document-id)</code></div><div class="doc"><div class="markdown"><p>Retrieve the <code>:id</code> <a href="fixpoint.core.html#var-property">property</a> for the given document.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L368">view source</a></div></div><div class="public anchor" id="var-ids"><h3>ids</h3><div class="usage"><code>(ids document-ids)</code></div><div class="doc"><div class="markdown"><p>Retrieve the <code>:id</code> <a href="fixpoint.core.html#var-property">property</a> for each of the given documents.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L373">view source</a></div></div><div class="public anchor" id="var-match"><h3>match</h3><div class="usage"><code>(match tags &amp; transformations)</code></div><div class="doc"><div class="markdown"><p>Look up a fixture document’s property for every entity that matches all of the given tags.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L359">view source</a></div></div><div class="public anchor" id="var-maybe-datasource"><h3>maybe-datasource</h3><div class="usage"><code>(maybe-datasource id)</code></div><div class="doc"><div class="markdown"><p>Get the <a href="fixpoint.core.html#var-Datasource">Datasource</a> registered with the given ID within the current scope, or <code>nil</code> if there is none.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L63">view source</a></div></div><div class="public anchor" id="var-on-datasource"><h3>on-datasource</h3><div class="usage"><code>(on-datasource data datasource-id)</code></div><div class="doc"><div class="markdown"><p>Declare the given fixture’s target datasource, corresponding to one to-be-instantiated within <a href="fixpoint.core.html#var-with-datasource">with-datasource</a> or <a href="fixpoint.core.html#var-with-rollback-datasource">with-rollback-datasource</a>.</p>
<pre><code class="clojure">(defn person
  [reference name]
  (-&gt; {:db/table :people
       :name     name}
      (as reference)
      (on-datasource :db)))

(with-datasource [ds (pg/make-datasource :db ...)]
  (with-data [(person :person/me  "me") ...]
    ...))
</code></pre>
<p>The result can be passed to <a href="fixpoint.core.html#var-with-data">with-data</a> to be run against the actual datasource.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L427">view source</a></div></div><div class="public anchor" id="var-properties"><h3>properties</h3><div class="usage"><code>(properties document-ids &amp; transformations)</code></div><div class="doc"><div class="markdown"><p>See <a href="fixpoint.core.html#var-property">property</a>. Performs a lookup in multiple fixture documents, returning values in an order corresponding to <code>document-ids</code>.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L353">view source</a></div></div><div class="public anchor" id="var-property"><h3>property</h3><div class="usage"><code>(property document-id &amp; transformations)</code></div><div class="doc"><div class="markdown"><p>Look up a single fixture document’s property using a reference attached to a fixture using <a href="fixpoint.core.html#var-as">as</a>.</p>
<pre><code class="clojure">(defn person
  [reference name]
  (-&gt; {:db/table :people
       :name     name}
      (as reference)
      (on-datasource :db)))

(with-datasource [ds (pg/make-datasource :db ...)]
  (with-data [(person :person/me  "me")
              (person :person/you "you")]
    (println (property :person/me))
    (println (property :person/you :id))))
</code></pre>
<p><code>transformations</code> can be given to apply a sequence of functions, in order, to the fixture map. Has to be used within a <a href="fixpoint.core.html#var-with-data">with-data</a> block.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L329">view source</a></div></div><div class="public anchor" id="var-raw-datasource"><h3>raw-datasource</h3><div class="usage"><code>(raw-datasource id)</code></div><div class="doc"><div class="markdown"><p>Get the raw datasource value for the <a href="fixpoint.core.html#var-Datasource">Datasource</a> registered under the given ID within the current scope.</p>
<p>See <a href="fixpoint.core.html#var-datasource">datasource</a> and <a href="fixpoint.core.html#var-as-raw-datasource">as-raw-datasource</a>.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L77">view source</a></div></div><div class="public anchor" id="var-use-data"><h3>use-data</h3><div class="usage"><code>(use-data &amp; fixtures)</code></div><div class="doc"><div class="markdown"><p>A clojure.test fixture that will insert the given fixtures into their respective datasources.</p>
<p>Needs to be applied after <a href="fixpoint.core.html#var-use-datasources">use-datasources</a>.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L416">view source</a></div></div><div class="public anchor" id="var-use-datasources"><h3>use-datasources</h3><div class="usage"><code>(use-datasources &amp; datasources)</code></div><div class="doc"><div class="markdown"><p>A clojure.test fixture that will wrap test runs with startup/shutdown of the given datasources. After the tests have run, a rollback will be initiated to cleanup the database.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L402">view source</a></div></div><div class="public anchor" id="var-with-data"><h3>with-data</h3><h4 class="type">macro</h4><div class="usage"><code>(with-data fixtures &amp; body)</code></div><div class="doc"><div class="markdown"><p>Given a <a href="fixpoint.core.html#var-Fixture">Fixture</a> (or a seq of them), run them against their respective datasources, then execute <code>body</code>.</p>
<pre><code class="clojure">(defn person
  [name]
  (-&gt; {:db/table :people
       :name     name}
      (on-datasource :db)))

(with-datasource [ds (pg/make-datasource :db ...)]
  (with-data [(person "me") (person "you")]
    ...))
</code></pre>
<p>This has to be wrapped by <a href="fixpoint.core.html#var-with-datasource">with-datasource</a> or <a href="fixpoint.core.html#var-with-rollback-datasource">with-rollback-datasource</a> since otherwise there is nothing to insert into.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L307">view source</a></div></div><div class="public anchor" id="var-with-datasource"><h3>with-datasource</h3><h4 class="type">macro</h4><div class="usage"><code>(with-datasource [sym datasource] &amp; body)</code></div><div class="doc"><div class="markdown"><p>Start <code>datasource</code> and bind it to <code>sym</code>, then run <code>body</code> in its scope.</p>
<pre><code class="clojure">(with-datasource [ds (pg/make-datasource ...)]
  ...)
</code></pre></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L124">view source</a></div></div><div class="public anchor" id="var-with-rollback"><h3>with-rollback</h3><h4 class="type">macro</h4><div class="usage"><code>(with-rollback [sym datasource] &amp; body)</code></div><div class="doc"><div class="markdown"><p>Run the given body within a ‘transacted’ version of the given datasource, rolling back after the run has finished.</p>
<pre><code class="clojure">(with-datasource [ds (pg/make-datasource ...)]
  (with-rollback [tx ds]
    (let [db (as-jdbc-datasource tx)]
      (jdbc/execute! db ["INSERT INTO ..." ...]))))
</code></pre></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L98">view source</a></div></div><div class="public anchor" id="var-with-rollback-datasource"><h3>with-rollback-datasource</h3><h4 class="type">macro</h4><div class="usage"><code>(with-rollback-datasource [sym datasource] &amp; body)</code></div><div class="doc"><div class="markdown"><p>Start a ‘transacted’ version of <code>datasource</code>, rolling back any changed made after the run has finished.</p>
<pre><code class="clojure">(with-rollback-datasource [ds (pg/make-datasource ...)]
  (let [db (as-jdbc-datasource ds)]
    (jdbc/execute! db ["INSERT INTO ..." ...])))
</code></pre>
<p>This is a convenience function combining <a href="fixpoint.core.html#var-with-datasource">with-datasource</a> and <a href="fixpoint.core.html#var-with-rollback">with-rollback</a>.</p></div></div><div class="src-link"><a href="https://github.com/stylefruits/fixpoint/blob/master/src/fixpoint/core.clj#L136">view source</a></div></div></div></body></html>